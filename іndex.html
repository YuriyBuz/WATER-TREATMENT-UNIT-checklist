<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Інтерактивний чек-лист: Контроль роботи ХВО</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #f8fafc; /* slate-50 */
            --card-bg-color: #ffffff;
            --text-color: #1e293b; /* slate-800 */
            --text-muted-color: #64748b; /* slate-500 */
            --item-bg-color: #f1f5f9; /* slate-100 */
            --item-hover-bg-color: #e2e8f0; /* slate-200 */
            --border-color: #e2e8f0;
            --priority-border-color: #fecaca; /* red-200 */
            --header-icon-hover-bg: #e5e7eb; /* gray-200 */
        }

        .dark {
            --bg-color: #1e293b; /* slate-800 */
            --card-bg-color: #334155; /* slate-700 */
            --text-color: #f1f5f9; /* slate-100 */
            --text-muted-color: #94a3b8; /* slate-400 */
            --item-bg-color: #475569; /* slate-600 */
            --item-hover-bg-color: #64748b; /* slate-500 */
            --border-color: #475569;
            --priority-border-color: #991b1b; /* red-800 */
            --header-icon-hover-bg: #475569; /* slate-600 */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 6rem; /* Space for fixed footer */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .card { background-color: var(--card-bg-color); }
        .text-muted { color: var(--text-muted-color); }
        .header-icon:hover { background-color: var(--header-icon-hover-bg); }

        .checklist-item {
            background-color: var(--item-bg-color);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .checklist-item:hover { background-color: var(--item-hover-bg-color); }
        
        .checklist-item.completed {
            background-color: var(--item-hover-bg-color);
            color: var(--text-muted-color);
        }
        .checklist-item.completed .task-text { text-decoration: line-through; }
        .checklist-item.completed .checkbox-icon::after { content: '✔'; color: #10b981; }
        
        .priority-item { border: 1px solid var(--priority-border-color); } 
        
        .nav-button.active { background-color: #059669; color: white; border-color: #059669; }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }

        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); z-index: 1000; }
        .modal-content { z-index: 1001; }
        
        .disabled-checklist-item { 
            pointer-events: none; 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        
        .comment-text { font-size: 0.875rem; color: var(--text-muted-color); padding-left: 3.25rem; }

        @media print {
            body { padding-bottom: 0; }
            header, .mb-6.card, nav, #footerStatus, .modal-overlay, .actions, button {
                display: none !important;
            }
            main, section, .card {
                display: block !important;
                box-shadow: none !important;
                border: none !important;
            }
            .checklist-item { page-break-inside: avoid; }
            .checklist-item.completed .checkbox-icon::after { content: '✔'; }
            .checklist-item:not(.completed) .checkbox-icon::after { content: '☐'; }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-50">

    <div class="container mx-auto max-w-3xl p-4 sm:p-6 lg:p-8">
        
        <header class="relative text-center mb-6">
             <div class="absolute top-0 left-0 text-center">
                <a href="#" onclick="event.preventDefault();" class="inline-block p-2 rounded-full text-muted header-icon transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500" title="На головну">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                </a>
                <div id="current-date" class="text-muted text-xs mt-1"></div>
             </div>

            <img src="https://foodline-production.com/wp-content/uploads/2021/10/3752781497_3752781497.webp" alt="Foodline Production Logo" class="w-24 h-auto mx-auto mb-4 rounded-lg" onerror="this.style.display='none'">
            <h1 class="text-2xl sm:text-3xl font-bold">Чек-лист Контролю роботи ХВО</h1>
            <p class="text-muted">Регламент операційного контролю установки водопідготовки</p>

             <div class="absolute top-0 right-0 flex space-x-2">
                 <button id="printBtn" class="p-2 rounded-full text-muted header-icon transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500" title="Друк / Зберегти в PDF">
                     <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                 </button>
                 <button id="themeToggle" class="p-2 rounded-full text-muted header-icon transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500" title="Темна/Світла тема">
                     <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                 </button>
             </div>
        </header>
        
        <div class="mb-6 card p-4 rounded-xl shadow-sm">
            <label for="employeeSelect" class="block text-sm font-bold mb-2">Оператор контролю:</label>
            <select id="employeeSelect" class="block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 card text-muted">
                <option value="">Оберіть зі списку</option>
            </select>
            <p id="employeeSelectionHint" class="text-red-500 text-xs mt-2 hidden">Будь ласка, оберіть своє ім'я, щоб розпочати роботу з чек-листом.</p>
        </div>

        <nav class="flex justify-center items-center mb-6 card p-2 rounded-xl shadow-sm">
            <button id="dailyBtn" class="nav-button active w-1/2 text-center py-2 px-4 rounded-lg font-semibold border border-transparent focus:outline-none transition-all duration-300">Щоденний контроль</button>
            <!-- *** MODIFIED BUTTON TEXT *** -->
            <button id="weeklyBtn" class="nav-button w-1/2 text-center py-2 px-4 rounded-lg font-semibold border border-transparent focus:outline-none transition-all duration-300">Щотижневий (Четвер)</button>
        </nav>

        <main>
            <!-- Daily Control Section -->
            <section id="dailySection">
                <div class="card p-4 sm:p-6 rounded-2xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-xl sm:text-2xl font-bold text-emerald-800 dark:text-emerald-300">Щоденний операційний контроль</h2>
                         <button id="resetDaily" class="px-3 py-1 bg-orange-500 text-white text-sm font-semibold rounded-lg hover:bg-orange-600 transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-400">Скинути</button>
                    </div>
                    <p class="text-muted mb-4">Перевірки на початку кожної зміни та з періодичністю, зазначеною нижче, з обов'язковою реєстрацією параметрів у Журналі щоденного контролю.</p>
                    
                    <div class="space-y-3">
                        <div>
                            <!-- *** MODIFIED HEADER TEXT *** -->
                            <h3 class="font-bold text-lg mb-2">2.1. Загальний візуальний контроль (На початку зміни)</h3>
                            <ul class="space-y-2" data-section="daily">
                                <li id="daily-2-1-1" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="daily-2-1-2" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="daily-2-1-3" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="daily-2-1-4" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="daily-2-1-5" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-2">2.2. Контроль параметрів тиску (Реєстрація на початку зміни)</h3>
                            <ul class="space-y-2" data-section="daily">
                                <li id="daily-2-2-1" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="daily-2-2-2" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="daily-2-2-3" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="daily-2-2-4" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="daily-2-2-5" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-2">2.3. Контроль вузла пом'якшення (S-05) (Критичний щоденний контроль)</h3>
                            <ul class="space-y-2" data-section="daily">
                                <li id="daily-2-3-1" class="checklist-item priority-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="daily-2-3-2" class="checklist-item priority-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="daily-2-3-3" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="daily-2-3-4" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                            </ul>
                        </div>
                         <div>
                            <h3 class="font-bold text-lg mb-2">2.4. Контроль вузла змішування (MIX-04) (Критичний щоденний контроль)</h3>
                            <ul class="space-y-2" data-section="daily">
                                <li id="daily-2-4-1" class="checklist-item priority-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <!-- REMOVED daily-2-4-2 -->
                                <li id="daily-2-4-3" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="daily-2-4-4" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Weekly Control Section -->
            <section id="weeklySection" class="hidden">
                 <div class="card p-4 sm:p-6 rounded-2xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-xl sm:text-2xl font-bold text-sky-800 dark:text-sky-300">Щотижневий технічний контроль</h2>
                         <button id="resetWeekly" class="px-3 py-1 bg-orange-500 text-white text-sm font-semibold rounded-lg hover:bg-orange-600 transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-400">Скинути</button>
                    </div>
                    <p class="text-muted mb-4">Контроль, що вимагає примусового запуску циклів регенерації для спостереження за їх коректним виконанням (Рекомендовано: Четвер).</p>

                    <div class="space-y-3">
                        <div>
                             <h3 class="font-bold text-lg mb-2">3.1. Контроль регенерації установки знезалізнення (F-03)</h3>
                             <ul class="space-y-2" data-section="weekly">
                                <li id="weekly-3-1-1" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="weekly-3-1-2" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="weekly-3-1-3" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="weekly-3-1-4" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="weekly-3-1-5" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                             </ul>
                        </div>
                        <div>
                             <h3 class="font-bold text-lg mb-2">3.2. Контроль регенерації установки пом'якшення (S-05) (Критичний)</h3>
                             <ul class="space-y-2" data-section="weekly">
                                <li id="weekly-3-2-1" class="checklist-item priority-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="weekly-3-2-2" class="checklist-item priority-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="weekly-3-2-3" class="checklist-item priority-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="weekly-3-2-4" class="checklist-item priority-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="weekly-3-2-5" class="checklist-item priority-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                             </ul>
                        </div>
                         <div>
                             <h3 class="font-bold text-lg mb-2">3.3. Обслуговування вузла аерації (A-02)</h3>
                             <ul class="space-y-2" data-section="weekly">
                                <li id="weekly-3-3-1" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                                <li id="weekly-3-3-2" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                             </ul>
                        </div>
                         <div>
                             <h3 class="font-bold text-lg mb-2">3.4. Контроль байпасних вентилів</h3>
                             <ul class="space-y-2" data-section="weekly">
                                <li id="weekly-3-4-1" class="checklist-item flex-wrap p-3 rounded-lg cursor-pointer disabled-checklist-item"></li>
                             </ul>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Fixed Footer -->
    <div id="footerStatus" class="fixed bottom-0 left-0 right-0 card p-4 shadow-lg flex items-center justify-between z-40" style="border-top: 1px solid var(--border-color);">
        <div class="w-full">
            <div class="w-full bg-gray-200 dark:bg-slate-600 rounded-full h-2.5 mb-2">
                <div id="currentProgressBar" class="progress-bar-fill bg-emerald-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="currentStatus" class="text-sm text-muted text-right">Залишилось завдань: 0</p>
        </div>
    </div>

    <!-- Modals -->
    <div id="completionModal" class="fixed inset-0 hidden items-center justify-center modal-overlay"></div>
    <div id="commentModal" class="fixed inset-0 hidden items-center justify-center modal-overlay"></div>
    <div id="statusModal" class="fixed inset-0 hidden items-center justify-center modal-overlay"></div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const checklistData = {
                // Daily Section 2.1
                'daily-2-1-1': 'Контроль протікань: Візуально оглянути всі вузли системи... на предмет відсутності протікань води.',
                'daily-2-1-2': 'Контроль дренажу: Переконатися, що дренажні труби не протікають.',
                'daily-2-1-3': 'Контроль електроживлення: Переконатися, що на дисплеях всіх керуючих клапанів... відображається коректний поточний час.',
                'daily-2-1-4': 'Контроль шумів: Прислухатися до відсутності сторонніх, нехарактерних шумів.',
                'daily-2-1-5': 'Контроль байпасу: Переконатися, що головний байпасний вентиль установки знаходиться у закритому положенні.',
                // Daily Section 2.2
                'daily-2-2-1': 'Зареєструвати тиск на вході (КТК-1, PI 0101). Норма: 3.0 – 6.0 бар.',
                'daily-2-2-2': 'Зареєструвати тиск повітря на аерацію (КТК-3). Норма: 5.0 – 8.0 бар.',
                'daily-2-2-3': 'Зареєструвати тиск на вході знезалізнення (КТК-4, PI 0302).',
                'daily-2-2-4': 'Зареєструвати тиск на виході знезалізнення (КТК-4, PI 0301).',
                'daily-2-2-5': 'Розрахувати ΔP на F-03 (PI 0302 - PI 0301).',
                // Daily Section 2.3
                'daily-2-3-1': 'Візуально перевірити рівень таблетованої солі (NaCl) у сольових баках TS-04/1 та TS-04/2.',
                'daily-2-3-2': 'Контроль "сольових мостів": Перевірити наявність злежування солі.',
                'daily-2-3-3': 'Перевірити статуси керуючих клапанів S-05. (Один "SERVICE", інший "STANDBY").',
                'daily-2-3-4': 'Записати залишок фільтроциклу (об\'єм в м³) до наступної регенерації на робочому фільтрі.',
                // Daily Section 2.4
                'daily-2-4-1': 'Записати попередній показник жорсткості на виході (з журналу реєстрацій аналізів).',
                'daily-2-4-3': 'Зареєструвати поточне налаштування ротаметра FI 0502 (фільтрованої води), л/хв.',
                'daily-2-4-4': 'Зареєструвати поточне налаштування ротаметра FI 0501 (пом\'якшеної води), л/хв.',
                // Weekly Section 3.1
                'weekly-3-1-1': 'Перевірити журнал регенерацій на клапанах Clack (F-03). Переконатися, що регенерація відбувається автоматично.',
                'weekly-3-1-2': 'Ініціювати примусову регенерацію одного з фільтрів F-03.',
                'weekly-3-1-3': 'Контроль циклів F-03: Цикл 1: Зворотна промивка (Backwash) (8-12 хв). Переконатися у наявності потоку.',
                'weekly-3-1-4': 'Контроль циклів F-03: Цикл 2: Пряма промивка (Rinse) (5-8 хв). Переконатися, що потік в дренаж є.',
                'weekly-3-1-5': 'Відмітити коректне проходження циклів F-03 та повторити для другого фільтра.',
                // Weekly Section 3.2
                'weekly-3-2-1': 'Перевірити лічильники на клапанах S-05. Переконатися, що фільтроцикл налаштований коректно (проектне 20 м³).',
                'weekly-3-2-2': 'Ініціювати примусову регенерацію одного з фільтрів S-05.',
                'weekly-3-2-3': '(Критично!) Цикл 2 (Brine Draw): Візуально контролювати, що рівень розчину в сольовому баку повільно знижується.',
                'weekly-3-2-4': '(Критично!) Цикл 5 (Refill): Спостерігати за наповненням сольового бака водою, переконатися, що поплавок спрацював.',
                'weekly-3-2-5': 'Відмітити коректне проходження критичних циклів (2 та 5) S-05 та повторити для другого фільтра.',
                // Weekly Section 3.3
                'weekly-3-3-1': 'Перевірити вузол підготовки повітря (A-02/1).',
                'weekly-3-3-2': 'Дія: Спустити конденсат з фільтра-вологовіддільника (та/або масловіддільника) на лінії стисненого повітря.',
                // Weekly Section 3.4
                'weekly-3-4-1': 'Короткочасно (10-15 сек) перевести систему в режим "BYPASS" і повернути в "SERVICE" для запобігання "прикипанню".'
            };
            
            const employees = ["Максимюк А.", "Мозговий О."];
            
            Object.keys(checklistData).forEach(id => {
                const itemEl = document.getElementById(id);
                if(itemEl) {
                    itemEl.innerHTML = `
                        <div class="flex items-center w-full">
                            <span class="checkbox-icon w-6 h-6 mr-3 border-2 border-gray-300 dark:border-slate-500 rounded-md flex items-center justify-center text-lg font-bold flex-shrink-0"></span>
                            <span class="task-text flex-1 min-w-0 break-words">${checklistData[id]}</span>
                            <div class="actions ml-auto flex items-center pl-2">
                                <button class="comment-btn p-1 rounded-full hover:bg-gray-200 dark:hover:bg-slate-600" title="Додати коментар">
                                    <svg class="h-5 w-5 text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="comment-text mt-1 hidden w-full break-words"></div>
                    `;
                }
            });
            
            if (!checklistData['daily-2-4-2']) {
                const itemToRemove = document.getElementById('daily-2-4-2');
                if (itemToRemove) itemToRemove.remove();
            }


            document.getElementById('completionModal').innerHTML = `
                <div class="card p-6 rounded-2xl shadow-xl max-w-sm w-full text-center modal-content mx-4">
                    <h3 id="modalMessage" class="text-xl font-bold mb-4"></h3>
                    <button id="closeModalBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-400">Закрити</button>
                    <a id="sendReportLink" href="#" class="block mt-4 text-blue-600 dark:text-blue-400 hover:underline">Надіслати звіт на пошту</a>
                </div>`;

            document.getElementById('commentModal').innerHTML = `
                <div class="card p-6 rounded-2xl shadow-xl max-w-sm w-full text-center modal-content mx-4">
                    <h3 class="text-xl font-bold mb-4">Ваш коментар</h3>
                    <textarea id="commentTextarea" class="w-full p-2 border border-gray-300 dark:border-slate-600 rounded-lg card text-muted focus:outline-none focus:ring-2 focus:ring-emerald-500" rows="4"></textarea>
                    <div class="mt-4 flex justify-end space-x-2">
                         <button id="cancelCommentBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">Скасувати</button>
                         <button id="saveCommentBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-400">Зберегти</button>
                    </div>
                </div>`;
            
            document.getElementById('statusModal').innerHTML = `
                <div class="card p-6 rounded-2xl shadow-xl max-w-sm w-full text-center modal-content mx-4">
                    <h3 class="text-xl font-bold mb-4">Перевірка статусу</h3>
                    <p class="text-muted mb-6">Переконайтесь, що ХВО знаходиться в режимі очистки.</p>
                    <div class="flex justify-between space-x-2">
                         <button id="statusNotWorkingBtn" class="w-1/2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-400">Не працює</button>
                         <button id="statusWorksBtn" class="w-1/2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-400">Працює</button>
                    </div>
                </div>`;
            
            // Element Refs
            const allChecklistItems = document.querySelectorAll('.checklist-item');
            const employeeSelect = document.getElementById('employeeSelect');
            const employeeSelectionHint = document.getElementById('employeeSelectionHint');
            let appState = {};
            const STORAGE_KEY = 'hvoChecklistState'; 

            // --- State Management ---
            const saveState = () => {
                const state = {
                    checklist: {},
                    employee: employeeSelect.value,
                    theme: document.body.classList.contains('dark') ? 'dark' : 'light',
                    dailyReportSent: appState.dailyReportSent || false // *** ADDED ***
                };
                
                allChecklistItems.forEach(item => {
                    // Check if item exists in checklistData before saving
                    if (checklistData[item.id]) { 
                        state.checklist[item.id] = {
                            completed: item.classList.contains('completed'),
                            comment: item.querySelector('.comment-text').textContent
                        };
                    }
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            };

            const loadState = () => {
                const savedState = localStorage.getItem(STORAGE_KEY);
                if (savedState) {
                    appState = JSON.parse(savedState);
                    appState.dailyReportSent = appState.dailyReportSent || false; // *** ADDED ***

                    if (appState.checklist) {
                        allChecklistItems.forEach(item => {
                            const itemState = appState.checklist[item.id];
                            if (itemState) {
                                if (itemState.completed) item.classList.add('completed');
                                if (itemState.comment) {
                                    const commentEl = item.querySelector('.comment-text');
                                    commentEl.textContent = itemState.comment;
                                    commentEl.classList.remove('hidden');
                                }
                            }
                        });
                    }
                    
                    if (appState.employee) {
                        employeeSelect.value = appState.employee;
                        if(employeeSelect.value) {
                             document.querySelectorAll('.checklist-item').forEach(i => i.classList.remove('disabled-checklist-item'));
                             employeeSelectionHint.classList.add('hidden');
                        }
                    }

                    if (appState.theme === 'dark') {
                        document.body.classList.add('dark');
                    }
                }
            };
            
            // --- UI & Event Listeners ---
            const commentModal = document.getElementById('commentModal');
            const commentTextarea = document.getElementById('commentTextarea');
            const completionModal = document.getElementById('completionModal');
            const statusModal = document.getElementById('statusModal');
            const statusWorksBtn = document.getElementById('statusWorksBtn');
            const statusNotWorkingBtn = document.getElementById('statusNotWorkingBtn');
            
            let currentCommentItem = null;
            let tempEmployeeValue = ""; 

            allChecklistItems.forEach(item => {
                item.addEventListener('click', (event) => {
                    if (employeeSelect.value && !event.target.closest('.actions')) {
                        item.classList.toggle('completed');
                        saveState();
                        updateProgress();
                    } else if (!employeeSelect.value) {
                        employeeSelectionHint.classList.remove('hidden');
                        employeeSelect.focus();
                    }
                });

                item.querySelector('.comment-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    currentCommentItem = item;
                    commentTextarea.value = item.querySelector('.comment-text').textContent;
                    commentModal.style.display = 'flex';
                    commentTextarea.focus();
                });
            });

            document.getElementById('saveCommentBtn').addEventListener('click', () => {
                if (currentCommentItem) {
                    const commentEl = currentCommentItem.querySelector('.comment-text');
                    const newComment = commentTextarea.value.trim();
                    commentEl.textContent = newComment;
                    commentEl.classList.toggle('hidden', !newComment);
                    saveState();
                }
                commentModal.style.display = 'none';
            });
            
            document.getElementById('cancelCommentBtn').addEventListener('click', () => {
                commentModal.style.display = 'none';
            });
            
            const generateAndSendReport = (section) => {
                if (!employeeSelect.value) {
                    employeeSelectionHint.classList.remove('hidden');
                    employeeSelect.focus();
                    return; 
                }
                
                const items = document.querySelectorAll(`#${section}Section .checklist-item`);
                const sectionTitle = (section === 'daily') ? 'Щоденний контроль ХВО' : 'Щотижневий контроль ХВО';
                const date = new Date().toLocaleString('uk-UA', { dateStyle: 'short', timeStyle: 'short' });

                let reportBody = `Звіт по чек-листу Контролю роботи ХВО\n\n`;
                reportBody += `Розділ: ${sectionTitle}\n`;
                reportBody += `Оператор: ${employeeSelect.value}\n`;
                reportBody += `Дата та час: ${date}\n\n`;
                reportBody += `СТАТУС ЗАВДАНЬ:\n--------------------------------\n`;

                items.forEach((item, index) => {
                    const taskText = item.querySelector('.task-text').textContent.trim();
                    const isCompleted = item.classList.contains('completed') ? '✅ Виконано' : '❌ Не виконано';
                    const comment = item.querySelector('.comment-text').textContent.trim();
                    
                    reportBody += `${index + 1}. ${taskText}\n   Статус: ${isCompleted}\n`;
                    if (comment) {
                        reportBody += `   Коментар: ${comment}\n`;
                    }
                    reportBody += `\n`;
                });

                const emailSubject = encodeURIComponent(`Звіт ХВО: ${sectionTitle} - ${employeeSelect.value}`);
                const emailBody = encodeURIComponent(reportBody);
                const recipients = 'Buznitskiy7@gmail.com,Dyndarnastia@gmail.com'; 
                
                // Use timeout to allow UI to update before mail client blocks script
                setTimeout(() => {
                    window.location.href = `mailto:${recipients}?subject=${emailSubject}&body=${emailBody}`;
                }, 100);
            };

            const showCompletionModal = (section) => {
                const modalMessage = document.getElementById('modalMessage');
                const sendReportLink = document.getElementById('sendReportLink');
                
                let message = (section === 'daily') ? "Щоденний контроль завершено. Звіт відправлено." : "Щотижневий контроль завершено. Дякуємо!";
                modalMessage.textContent = message;
                
                // For weekly, show link. For daily, it's automatic.
                if (section === 'weekly') {
                    sendReportLink.style.display = 'block';
                    sendReportLink.onclick = (e) => {
                        e.preventDefault();
                        generateAndSendReport(section);
                    };
                } else {
                    sendReportLink.style.display = 'none';
                }

                completionModal.style.display = 'flex';
            };
            
            const dailyBtn = document.getElementById('dailyBtn');
            const weeklyBtn = document.getElementById('weeklyBtn');
            const dailySection = document.getElementById('dailySection');
            const weeklySection = document.getElementById('weeklySection');
            
            const footerStatus = document.getElementById('footerStatus');
            const currentProgressBar = document.getElementById('currentProgressBar');
            const currentStatus = document.getElementById('currentStatus');
            
            const resetDailyBtn = document.getElementById('resetDaily');
            const resetWeeklyBtn = document.getElementById('resetWeekly');
            
            const themeToggle = document.getElementById('themeToggle');
            const printBtn = document.getElementById('printBtn');
            
            const closeModalBtn = document.getElementById('closeModalBtn');
            
            let currentSection = 'daily'; 

            employees.forEach(e => employeeSelect.add(new Option(e, e)));

            employeeSelect.addEventListener('change', () => {
                tempEmployeeValue = employeeSelect.value;
                if (tempEmployeeValue) {
                    statusModal.style.display = 'flex';
                } else {
                    document.querySelectorAll('.checklist-item').forEach(i => i.classList.add('disabled-checklist-item'));
                    saveState();
                }
            });

            statusWorksBtn.addEventListener('click', () => {
                statusModal.style.display = 'none';
                employeeSelect.value = tempEmployeeValue;
                document.querySelectorAll('.checklist-item').forEach(i => i.classList.remove('disabled-checklist-item'));
                employeeSelectionHint.classList.add('hidden');
                saveState();
            });

            statusNotWorkingBtn.addEventListener('click', () => {
                statusModal.style.display = 'none';
                employeeSelect.value = "";
                tempEmployeeValue = "";
                document.querySelectorAll('.checklist-item').forEach(i => i.classList.add('disabled-checklist-item'));
                saveState();
            });


            const switchView = (view) => {
                currentSection = view;
                [dailySection, weeklySection].forEach(s => s.classList.add('hidden')); 
                [dailyBtn, weeklyBtn].forEach(b => b.classList.remove('active')); 
                
                footerStatus.style.display = 'flex';

                if (view === 'daily') { 
                    dailySection.classList.remove('hidden');
                    dailyBtn.classList.add('active');
                } else if (view === 'weekly') { 
                    weeklySection.classList.remove('hidden');
                    weeklyBtn.classList.add('active');
                }
                updateProgress();
            };

            // *** MODIFIED updateProgress FOR AUTO-SEND ***
            const updateProgress = () => {
                const items = document.querySelectorAll(`#${currentSection}Section .checklist-item`);
                const completedItems = document.querySelectorAll(`#${currentSection}Section .checklist-item.completed`).length;
                const total = items.length;
                const percentage = total > 0 ? (completedItems / total) * 100 : 0;
                
                currentProgressBar.style.width = `${percentage}%`;
                
                if(total > 0 && completedItems === total) {
                     currentStatus.textContent = 'Чудова робота! Всі завдання виконано.';
                     
                     // *** NEW LOGIC FOR AUTOMATIC DAILY REPORT ***
                     if (currentSection === 'daily' && !appState.dailyReportSent) {
                         generateAndSendReport('daily');
                         appState.dailyReportSent = true;
                         saveState();
                     }
                     
                     if (completionModal.style.display !== 'flex') {
                        showCompletionModal(currentSection);
                     }
                } else {
                     currentStatus.textContent = `Залишилось завдань: ${total - completedItems}`;
                }
            };
            
            // *** MODIFIED resetDailyBtn TO RESET FLAG ***
            resetDailyBtn.addEventListener('click', () => { 
                if (window.confirm('Ви впевнені, що хочете скинути весь прогрес для щоденного контролю? Ця дія незворотня.')) {
                    appState.dailyReportSent = false; // *** ADDED ***
                    document.querySelectorAll('#dailySection .checklist-item').forEach(item => {
                        item.classList.remove('completed');
                        const commentEl = item.querySelector('.comment-text');
                        commentEl.textContent = '';
                        commentEl.classList.add('hidden');
                    });
                    saveState();
                    updateProgress();
                }
            });

            resetWeeklyBtn.addEventListener('click', () => { 
                if (window.confirm('Ви впевнені, що хочете скинути весь прогрес для щотижневого контролю? Ця дія незворотня.')) {
                    document.querySelectorAll('#weeklySection .checklist-item').forEach(item => {
                        item.classList.remove('completed');
                        const commentEl = item.querySelector('.comment-text');
                        commentEl.textContent = '';
                        commentEl.classList.add('hidden');
                    });
                    saveState();
                    updateProgress();
                }
            });

            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark');
                saveState();
            });
            
            printBtn.addEventListener('click', () => window.print());

            dailyBtn.addEventListener('click', () => switchView('daily'));
            weeklyBtn.addEventListener('click', () => switchView('weekly'));
            
            closeModalBtn.addEventListener('click', () => completionModal.style.display = 'none');
            
            [completionModal, commentModal, statusModal].forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                        if (modal === statusModal) {
                            employeeSelect.value = "";
                            tempEmployeeValue = "";
                            saveState();
                        }
                    }
                });
            });

            // --- Initial Load ---
            const displayDate = () => {
                const dateElement = document.getElementById('current-date');
                if (dateElement) {
                    const now = new Date();
                    const options = { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' };
                    const formattedDate = new Intl.DateTimeFormat('uk-UA', options).format(now);
                    dateElement.textContent = formattedDate.charAt(0).toUpperCase() + formattedDate.slice(1);
                }
            };

            loadState();
            displayDate();
            switchView('daily'); 
        });
    </script>

</body>
</html>